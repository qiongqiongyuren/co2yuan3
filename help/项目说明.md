# 项目核心逻辑说明

本文档旨在总结碳排放数据监测与分析平台的核心逻辑和关键实现，为项目归档或未来迁移提供参考。

## 1. 核心功能概述

- **用户认证**: 提供基于 JWT (JSON Web Token) 的登录和注册功能。
- **数据填报**: 结构化的多层级表单，用于提交不同地区和年份的碳排放活动数据。
- **数据看板**:
  - 以表格形式展示历史数据，支持按年份和行政区划搜索。
  - 提供将筛选后的数据导出为多 Sheet Excel 文件的功能。
- **数据可视化**:
  - **数据大屏**: 包含统计卡片和多维度图表，用于宏观数据展示。
  - **图表分析**: 针对单条数据记录进行深度分析，包含饼图、柱状图和折线图等。
  - **排放地图**: 在地图上以热力图形式展示各区域的碳排放强度。

## 2. 技术栈

- **前端**: React, Vite, Material-UI (MUI), ECharts, Axios
- **后端**: Node.js, Express.js, MongoDB, Mongoose, JWT, ExcelJS

## 3. 前端核心逻辑

### 3.1. 状态管理与数据流

项目采用自定义 Hooks 的方式进行状态管理，实现了业务逻辑与 UI 组件的有效解耦。

- **`useCarbonData.js`**: 这是数据看板页面的“大脑”，封装了所有与碳数据相关的状态（如 `submittedData`, `loadingData`）和操作（如 `handleSearch`, `handleDelete`, `handleFormSubmit`, `handleExport`）。所有的数据请求（CRUD）都在此 Hook 中完成。
- **`useDataScreen.js`**: 负责数据大屏页面的数据获取和处理逻辑，为图表组件提供格式化后的数据。
- **`useRegions.js`**: 封装了获取行政区划数据的逻辑，供多个组件复用。

### 3.2. 关键组件

- **`DashboardPage.jsx`**: 作为应用的指挥中心，通过调用 `useCarbonData` 和 `useRegions` Hooks 获取数据和方法，管理页面级状态（如 `activeTab`, `selectedRecord`），并组合渲染 `SearchBar`, `HistoricalDataTable`, `ChartAnalysis` 等子组件。
- **`DataEntryForm.jsx`**: 使用 React Hook Form 构建的复杂表单，负责碳排放活动数据的录入。
- **`Chart` 组件 (`/components/charts/`)**: 所有图表都被封装成独立的 React 组件，接收 `props` 传入数据，使用 ECharts 进行渲染。

## 4. 后端核心逻辑

### 4.1. API 路由与控制器

后端采用经典的 MVC (Model-View-Controller) 模式组织代码。

- **`routes/`**: 定义 API 端点，例如 `carbonData.js` 路由负责处理所有与碳数据相关的请求。所有路由都通过 `protect` 中间件进行身份验证。
- **`controllers/`**: 存放业务逻辑。
  - **`carbonData.js`**: 实现对碳数据的增删改查（CRUD）操作。
  - **`auth.js`**: 处理用户注册 (`register`) 和登录 (`login`) 逻辑，生成和验证 JWT。
  - **`reports.js`**: 负责生成数据报告。
    - `exportCsv`: （已保留）生成一个包含所有数据的扁平化 CSV 文件。
    - `exportExcel`: **核心导出功能**，使用 `exceljs` 库生成一个多 Sheet 的 Excel 文件，每个 Sheet 对应一种排放源（化石燃料、移动源、电力、热力），并包含中文表头。

### 4.2. 数据模型与计算引擎

- **`models/`**: 使用 Mongoose 定义数据模型。
  - **`CarbonData.js`**: 定义了碳数据的主要结构，包含 `year`, `regionCode`, `activityData` (一个包含所有填报数据的复杂嵌套对象) 和 `calculatedEmissions` (计算出的排放结果)。
  - **`Account.js`**: 定义了用户账户模型。
- **`utils/calculationEngine.js`**: **核心计算引擎**。此模块封装了所有碳排放量的计算算法。当有新的数据提交时，后端会调用此引擎，根据 `activityData` 和预设的排放因子（`emissionFactors.js`）计算出各种排放量，并将结果存入 `calculatedEmissions` 字段。

## 5. 总结

该项目是一个功能完备的全栈应用，其核心优势在于前端通过自定义 Hooks 实现了良好的逻辑解耦，后端通过清晰的 MVC 结构和独立的计算引擎实现了模块化。虽然在开发过程中遇到了一些挑战，但最终形成的核心逻辑为后续的维护或功能迁移提供了清晰的蓝图。
