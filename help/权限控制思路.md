### **ç¬¬ä¸€æ­¥ï¼šã€æ•°æ®åº“ã€‘è®¾è®¡ç”¨æˆ·æ¨¡å‹ `Account.js`**

æˆ‘ä»¬éœ€è¦åœ¨ç”¨æˆ·çš„æ•°æ®é‡Œæ˜ç¡®è®°ä¸‹ä»–çš„â€œèº«ä»½ç‰Œâ€ã€‚

**ğŸ“ æ–‡ä»¶ä½ç½®**: `server/models/Account.js`

**âœï¸ æ“ä½œ**: åœ¨ä½ çš„ `accountSchema` ä¸­æ·»åŠ  `role` å­—æ®µã€‚

JavaScript

```
const mongoose = require('mongoose');

const accountSchema = new mongoose.Schema({
    username: { type: String, required: true, unique: true },
    password: { type: String, required: true },

    // ===== å–µï¼æ ¸å¿ƒæ”¹é€ ç‚¹åœ¨è¿™é‡Œ =====
    role: {
        type: String,
        // enum ä¼šç¡®ä¿å­˜å…¥æ•°æ®åº“çš„è§’è‰²å€¼å¿…é¡»æ˜¯æ•°ç»„ä¸­çš„ä¸€ä¸ªï¼Œé˜²æ­¢è„æ•°æ®
        enum: ['admin', 'editor', 'viewer'], 
        // è®¾ç½®ä¸€ä¸ªå®‰å…¨çš„é»˜è®¤å€¼ï¼Œæ–°æ³¨å†Œç”¨æˆ·é»˜è®¤ä¸ºæƒé™æœ€ä½çš„è§’è‰²
        default: 'viewer' 
    }
    // =================================
});

module.exports = mongoose.model('Account', accountSchema);
```

---

### **ç¬¬äºŒæ­¥ï¼šã€é…ç½®ã€‘å®šä¹‰è§’è‰²ä¸æƒé™ `permissions.js`**

å°†æ‰€æœ‰è§’è‰²å’Œæƒé™çš„å®šä¹‰é›†ä¸­ç®¡ç†ï¼Œè®©ä»£ç ä¸€ç›®äº†ç„¶ï¼Œä»¥åå¢åˆ æ”¹æŸ¥éƒ½è¶…æ–¹ä¾¿ï¼

**ğŸ“ å»ºè®®æ–°å¢**: `server/config/permissions.js`

**âœï¸ æ“ä½œ**: åˆ›å»ºå¹¶å¡«å†™ä»¥ä¸‹å†…å®¹ã€‚

JavaScript

```
// å®šä¹‰æ‰€æœ‰å¯ç”¨çš„è§’è‰²
const ROLES = {
    ADMIN: 'admin',
    EDITOR: 'editor',
    VIEWER: 'viewer'
};

// å®šä¹‰æ‰€æœ‰å¯ç”¨çš„æƒé™ (æ¨èæ ¼å¼: èµ„æº:æ“ä½œ)
const PERMISSIONS = {
    USERS_READ: 'users:read',
    USERS_WRITE: 'users:write',
    CARBON_DATA_READ: 'carbonData:read',
    CARBON_DATA_CREATE: 'carbonData:create',
    CARBON_DATA_UPDATE: 'carbonData:update',
    CARBON_DATA_DELETE: 'carbonData:delete',
    REPORTS_GENERATE: 'reports:generate'
};

// æ ¸å¿ƒï¼å°†æƒé™åˆ†é…ç»™è§’è‰²
const rolePermissions = {
    [ROLES.ADMIN]: [ /* ç®¡ç†å‘˜æ‹¥æœ‰æ‰€æœ‰æƒé™... */
        PERMISSIONS.USERS_READ, PERMISSIONS.USERS_WRITE,
        PERMISSIONS.CARBON_DATA_READ, PERMISSIONS.CARBON_DATA_CREATE,
        PERMISSIONS.CARBON_DATA_UPDATE, PERMISSIONS.CARBON_DATA_DELETE,
        PERMISSIONS.REPORTS_GENERATE
    ],
    [ROLES.EDITOR]: [ /* ç¼–è¾‘å‘˜å¯ä»¥è¯»ã€å†™ã€æ›´æ–°ç¢³æ•°æ®å’Œç”ŸæˆæŠ¥å‘Š */
        PERMISSIONS.CARBON_DATA_READ, PERMISSIONS.CARBON_DATA_CREATE,
        PERMISSIONS.CARBON_DATA_UPDATE, PERMISSIONS.REPORTS_GENERATE
    ],
    [ROLES.VIEWER]: [ /* è§‚å¯Ÿå‘˜åªèƒ½è¯»å–ç¢³æ•°æ®å’Œç”ŸæˆæŠ¥å‘Š */
        PERMISSIONS.CARBON_DATA_READ, PERMISSIONS.REPORTS_GENERATE
    ]
};

module.exports = {
    ROLES,
    PERMISSIONS,
    rolePermissions
};
```

---

### **ç¬¬ä¸‰æ­¥ï¼šã€ä¸­é—´ä»¶ã€‘åˆ›å»ºæƒé™å®ˆå« `permissions.js`**

è¿™æ˜¯æˆ‘ä»¬æœ€å¼ºå¤§çš„å®ˆå«ï¼Œå®ƒä¼šåœ¨è¯·æ±‚çš„è·¯ä¸Šæ£€æŸ¥ç”¨æˆ·çš„â€œèº«ä»½ç‰Œâ€ã€‚

**ğŸ“ å»ºè®®æ–°å¢**: `server/middleware/permissions.js`

**âœï¸ æ“ä½œ**: åˆ›å»ºå¹¶å¡«å†™æƒé™æ£€æŸ¥ä¸­é—´ä»¶ã€‚

JavaScript

```
const { rolePermissions } = require('../config/permissions');

// è¿™æ˜¯ä¸€ä¸ªé«˜é˜¶å‡½æ•°ï¼Œå®ƒæ¥æ”¶ä¸€ä¸ªâ€œæ‰€éœ€æƒé™â€ä½œä¸ºå‚æ•°ï¼Œ
// ç„¶åè¿”å›ä¸€ä¸ªçœŸæ­£çš„ Express ä¸­é—´ä»¶å‡½æ•°ã€‚
const checkPermission = (requiredPermission) => {
    return (req, res, next) => {
        // **å‰æ**: ä½ çš„è®¤è¯ä¸­é—´ä»¶å·²éªŒè¯äº† tokenï¼Œå¹¶å°†ç”¨æˆ·ä¿¡æ¯æŒ‚è½½åˆ°äº† req.user
        const user = req.user;

        if (!user || !user.role) {
            return res.status(401).json({ message: 'å–µ~ èº«ä»½ä¸æ˜ï¼Œç¦æ­¢å…¥å†…ï¼' });
        }

        // ä»é…ç½®ä¸­è·å–å½“å‰ç”¨æˆ·è§’è‰²æ‰€æ‹¥æœ‰çš„æ‰€æœ‰æƒé™
        const userPermissions = rolePermissions[user.role];

        // æ£€æŸ¥ç”¨æˆ·çš„æƒé™åˆ—è¡¨é‡Œï¼Œæ˜¯å¦åŒ…å«å½“å‰è·¯ç”±æ‰€è¦æ±‚çš„æƒé™
        if (userPermissions && userPermissions.includes(requiredPermission)) {
            // æ‹¥æœ‰æƒé™ï¼Œæ”¾è¡Œï¼
            return next();
        } else {
            // æ²¡æœ‰æƒé™ï¼Œæ‹¦æˆªï¼
            return res.status(403).json({ message: 'å–µå‘œï¼æƒé™ä¸è¶³ï¼Œè¿™ä¸ªä½ ä¸èƒ½ç¢°å“¦ï¼' });
        }
    };
};

module.exports = { checkPermission };
```

---

### **ç¬¬å››æ­¥ï¼šã€æ§åˆ¶å™¨ã€‘å¤„ç†ç”¨æˆ·æ³¨å†Œ `auth.js`**

åœ¨ç”¨æˆ·æ³¨å†Œæ—¶ï¼Œå°±æŠŠä»–ä»¬é€‰æ‹©çš„â€œèº«ä»½ç‰Œâ€å†™å…¥æ•°æ®åº“ã€‚

**ğŸ“ æ–‡ä»¶ä½ç½®**: `server/controllers/auth.js`

**âœï¸ æ“ä½œ**: ä¿®æ”¹ `register` å‡½æ•°ã€‚

JavaScript

```
const Account = require('../models/Account');
const bcrypt = require('bcryptjs');

exports.register = async (req, res) => {
    try {
        // ä»è¯·æ±‚ä½“ä¸­æ‹¿åˆ°å‰ç«¯ä¼ æ¥çš„ username, password å’Œ role
        const { username, password, role } = req.body;

        // ... (çœç•¥æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²å­˜åœ¨çš„ä»£ç )

        // å®‰å…¨æ£€æŸ¥ï¼šé˜²æ­¢ç”¨æˆ·è‡ªå·±æ³¨å†Œä¸ºç®¡ç†å‘˜
        const allowedRoles = ['editor', 'viewer'];
        if (role && !allowedRoles.includes(role)) {
            return res.status(400).json({ message: 'å–µï¼Ÿä¸å¯ä»¥é€‰æ‹©è¿™ä¸ªè§’è‰²å“¦ï¼' });
        }

        const hashedPassword = await bcrypt.hash(password, 12);

        // åˆ›å»ºæ–°ç”¨æˆ·æ—¶ï¼Œç›´æ¥å°† role å­˜è¿›å»
        const newUser = new Account({
            username,
            password: hashedPassword,
            role: role // å¦‚æœå‰ç«¯æ²¡ä¼  roleï¼Œæ¨¡å‹ä¸­çš„ default å€¼ä¼šç”Ÿæ•ˆ
        });

        await newUser.save();

        // ... (çœç•¥è¿”å›æˆåŠŸä¿¡æ¯å’Œ token çš„ä»£ç )
        res.status(201).json({ message: 'æ¬¢è¿åŠ å…¥ï¼ä½ å·²ç»æˆåŠŸæ³¨å†Œå•¦ï¼Œå–µ~' });

    } catch (error) {
        // ... (çœç•¥é”™è¯¯å¤„ç†)
    }
};
```

---

### **ç¬¬äº”æ­¥ï¼šã€è·¯ç”±ã€‘éƒ¨ç½²æƒé™å®ˆå«**

æœ€åä¸€æ­¥ï¼ŒæŠŠæˆ‘ä»¬çš„å®ˆå«éƒ¨ç½²åˆ°éœ€è¦ä¿æŠ¤çš„å„ä¸ªè·¯å£ï¼ˆAPI è·¯ç”±ï¼‰ä¸Šã€‚

**ğŸ“ æ–‡ä»¶ä½ç½®**: `server/routes/*.js` (ä¾‹å¦‚ `carbonData.js`)

**âœï¸ æ“ä½œ**: åœ¨è·¯ç”±å¤„ç†å‡½æ•°å‰ï¼ŒåŠ ä¸Š `checkPermission` ä¸­é—´ä»¶ã€‚

JavaScript

```
const express = require('express');
const router = express.Router();
const carbonDataController = require('../controllers/carbonData');

// ä½ çš„èº«ä»½è®¤è¯ä¸­é—´ä»¶ (æ£€æŸ¥æ˜¯å¦ç™»å½•)
const authMiddleware = require('../middleware/auth'); 
// æˆ‘ä»¬çš„æ–°æƒé™å®ˆå«ï¼
const { checkPermission } = require('../middleware/permissions');
// ä»é…ç½®ä¸­å¼•å…¥æƒé™å¸¸é‡ï¼Œè®©ä»£ç æ›´æ˜“è¯»
const { PERMISSIONS } = require('../config/permissions');

// ç¤ºä¾‹1: åªæœ‰æ‹¥æœ‰ "carbonData:create" æƒé™çš„è§’è‰²æ‰èƒ½è®¿é—®
router.post(
    '/',
    authMiddleware, // 1. å…ˆæ£€æŸ¥ç™»å½•çŠ¶æ€
    checkPermission(PERMISSIONS.CARBON_DATA_CREATE), // 2. å†æ£€æŸ¥æ“ä½œæƒé™
    carbonDataController.createData // 3. å…¨éƒ¨é€šè¿‡ï¼Œæ‰æ‰§è¡Œä¸šåŠ¡é€»è¾‘
);

// ç¤ºä¾‹2: åªæœ‰æ‹¥æœ‰ "carbonData:delete" æƒé™çš„è§’è‰² (å³ç®¡ç†å‘˜) æ‰èƒ½è®¿é—®
router.delete(
    '/:id',
    authMiddleware,
    checkPermission(PERMISSIONS.CARBON_DATA_DELETE),
    carbonDataController.deleteData
);

module.exports = router;
```
